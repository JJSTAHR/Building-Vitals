name: Backfill Oct 15 - Nov 7

on:
  workflow_dispatch:
    inputs:
      start_date:
        description: 'Start date (YYYY-MM-DD)'
        required: true
        default: '2025-10-15'
      end_date:
        description: 'End date (YYYY-MM-DD)'
        required: true
        default: '2025-11-07'

jobs:
  backfill:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Backfill data in 2-hour chunks
        env:
          FLIGHTDECK_TOKEN: ${{ secrets.FLIGHTDECK_TOKEN }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SITE_ID: ses_falls_city
        run: |
          echo "üöÄ Starting backfill from ${{ inputs.start_date }} to ${{ inputs.end_date }}"
          echo "üì¶ Processing in 2-hour chunks to handle large data volumes"

          # Convert dates to Unix timestamps (start of day)
          START_TS=$(date -d "${{ inputs.start_date }} 00:00:00" +%s)
          END_TS=$(date -d "${{ inputs.end_date }} 23:59:59" +%s)

          # 2-hour chunks (7200 seconds)
          CHUNK_SIZE=7200
          CURRENT_TS=$START_TS
          CHUNK_COUNT=0

          while [ $CURRENT_TS -le $END_TS ]; do
            CHUNK_COUNT=$((CHUNK_COUNT + 1))

            # Calculate chunk end time
            CHUNK_END_TS=$((CURRENT_TS + CHUNK_SIZE))
            if [ $CHUNK_END_TS -gt $END_TS ]; then
              CHUNK_END_TS=$END_TS
            fi

            # Convert to ISO format
            CHUNK_START=$(date -u -d "@$CURRENT_TS" +%Y-%m-%dT%H:%M:%SZ)
            CHUNK_END=$(date -u -d "@$CHUNK_END_TS" +%Y-%m-%dT%H:%M:%SZ)

            echo ""
            echo "=========================================="
            echo "Chunk $CHUNK_COUNT: $CHUNK_START to $CHUNK_END"
            echo "=========================================="

            # Run sync for this chunk
            node scripts/sync-to-supabase.js "$CHUNK_START" "$CHUNK_END"

            if [ $? -ne 0 ]; then
              echo "‚ùå Failed on chunk $CHUNK_COUNT"
              exit 1
            fi

            # Move to next chunk
            CURRENT_TS=$CHUNK_END_TS

            # Rate limiting - sleep 1 second between chunks
            if [ $CURRENT_TS -le $END_TS ]; then
              sleep 1
            fi
          done

          echo ""
          echo "=========================================="
          echo "‚úÖ Backfill Complete"
          echo "=========================================="
          echo "Chunks processed: $CHUNK_COUNT"
          echo "Date range: ${{ inputs.start_date }} to ${{ inputs.end_date }}"

      - name: Final status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "‚úÖ Backfill completed successfully"
          else
            echo "‚ùå Backfill failed"
          fi
